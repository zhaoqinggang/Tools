# 离岗复盘：客服 Agent / 训练评估闭环（不含代码与路径）

这份文档用于你未来复盘与对外表达：**我做过哪些系统（项目）**、每个系统的**关键技术思想**是什么、哪些做法能迁移到下一份工作。

原则：
- **不依赖任何代码/文件路径**（你带不走代码也能复盘）
- 用“系统/技术”组织标题，便于按模块回忆
- 在必要处给**典型场景例子**（不是引用实现细节）

---

## 项目一：客服 Agent 系统（线上推理链路）

### 一句话总结
把“用户一句话”稳定变成“可解释的决策 + 可执行的动作 + 可解析的输出”，并且**每一步都能复盘**。

### 关键目标
- 在真实客服场景下，把不确定的自然语言输入变成**可控、可解释、可执行**的输出
- 兼顾：效果、稳定性、成本、可维护性

### 核心架构思想：分层与门禁（把不确定性拆开管理）
把系统拆成明确层次，目的是降低耦合与可定位问题：
- **意图层**：先确定“走哪条路”（只要类别，低成本）
- **上下文补全层（关键）**：把该查的信息查出来，让模型从“编造者”变成“解释者”
- **状态层**：把多轮对话压缩成“当前可用事实”，而不是无限拼历史
- **策略层**：高频规则场景优先用结构化策略（SOP），否则走兜底策略
- **工具层**：把可判定对错的动作交给工具，模型负责决策与表达
- **输出契约层**：统一结构与边界条件，保证下游可解析、可展示
- **可观测层**：记录关键决策点，支持复盘与迭代

### 你可以直接复用的“标准处理流程”（文本版）
每次处理用户输入，都按下面顺序跑一遍（能显著提升稳定性）：

1) **判路**：先判断这是“聊天/致谢/辱骂/问候”还是“业务问题”
2) **定类型**：业务问题里，再分成“表达/查询/操作/投诉/确认/否认”等
3) **补上下文**（关键）：决定要不要查订单、查费用、查车辆、查账户
4) **做门禁**（关键）：如果用户要执行动作，先检查是否满足条件（否则拒绝并解释）
5) **选策略**：命中 SOP 就走 SOP；命中不强就做引导；否则走兜底策略
6) **组织输出**：按输出契约返回（文本 + 可选结构：选项/卡片/动作）
7) **更新状态**：把确认信息与关键事实写入状态，便于下一轮少问一句

### 技术主题：先查再答 / 先查再执行（最重要的工程化思想）
**先查再答**：涉及“事实”的问题（费用、订单状态、规则适用）先获取真实上下文再回答。  
**先查再执行**：涉及“动作”的请求（退费、关锁等）先验证条件再执行。

门禁（gating）要点：
- **必须满足的条件**：不满足就拒绝（避免误操作）
- **拒绝必须可解释**：告诉用户缺什么、为什么不行、下一步怎么做
- **默认值慎用**：默认值可用于演示/压测，但线上要尽量用真实上下文替代

### 技术主题：状态管理（多轮对话的“资产”）
状态的价值不在保存对话文本，而在积累可用事实：
- **已确认 vs 未确认**：未确认信息不要触发关键动作
- **对话阶段**：开始/澄清/执行/收尾，不同阶段策略不同
- **情绪信号**：影响措辞、是否先共情、是否先降火
- **实体累积与去重**：减少重复追问，避免状态污染

### 技术主题：SOP 产品化（把经验从话术变成“可执行结构”）
SOP 的价值不是“写得像话术”，而是：
- **一致性**：同类问题稳定输出
- **可运营**：可新增、可回滚、可 A/B
- **可结构化**：不仅是文本，还包括：
  - 告知内容（说什么）
  - 展示/交互（卡片/选项）
  - 工具调用时机（什么时候允许触发动作）
  - 前置事实要求（订单是否结束、费用是否存在等）

命中策略建议：
- 命中足够强 → 进入 SOP
- 命中不够强 → 输出“候选意图/候选选项”引导用户确认（不要硬套）

### 技术主题：输出契约优先（先保证可用，再追求好看）
在工具/结构化输出场景中：
- **结构稳定**通常比“文案好看”更重要
- 结构性错误（格式/标记/卡片/工具触发）往往比“回答一般”更致命

### 典型场景例子 1：用户说“被扣了调度费/乱扣费”
正确处理思路（更具体一些）：
- 意图多半是“表达/查询”，不应直接执行退费动作
- 主动补全：查“订单是否结束”“是否存在调度费”“调度费原因/规则字段是否齐全”
- 分支：
  - 若费用为 0：解释“未产生该费用”，结束
  - 若订单未结束：解释“需结束后核实/处理”，引导后续
  - 若确有费用：解释规则并给出选项，用户确认后才允许触发退费动作

复盘问题：
- 有没有做到“先查再答/先查再执行”？
- 拒绝是否可解释？是否减少无意义追问？

### 典型场景例子 2：用户说“帮我远程关锁还车”
你希望系统表现得像“可靠的业务系统”，而不是“随口答应的聊天机器人”：

- 这属于**操作请求**，必须走门禁
- 主动补全：查“是否存在骑行中的订单”“车辆是否属于该订单”“当前车辆是否允许远程关锁”
- 分支：
  - 若当前没有骑行中订单：解释“未找到骑行订单，无法远程关锁”，并引导用户确认是否是别的车辆/是否刚结束
  - 若订单存在但状态不允许：解释“当前状态不支持远程关锁”的原因（例如已结束/已关锁/不在骑行中）
  - 若条件满足：执行关锁动作，并返回“动作结果 + 下一步提示”（例如已关锁、是否需要确认还车成功）

复盘问题：
- 门禁条件是否清晰？拒绝是否可解释？
- 是否能做到“缺参时追问一次就够”（不来回折腾用户）？

### 典型场景例子 3：用户一句话很模糊（SOP 命中不强）
例如用户说“我订单有问题”，这时硬套任何 SOP 都容易错。

- 做法：输出 2–3 个“你是不是想问这个”的选项（费用异常/无法还车/车辆故障等），让用户点选或确认
- 价值：避免系统误判后把用户带偏，显著提升首轮命中率与用户体验

---

## 项目二：评估系统（离线评估 + 自动评估）

### 一句话总结
把“模型好不好”拆成可操作的维度，并把结果变成“下一步该修什么”的行动清单。

### 关键目标
评估不是“看分数”，而是回答：
1) **问题在哪里**（错误模式）  
2) **下一步怎么改**（行动建议）  

### 核心思想：强规则优先，弱规则补充
评估维度建议拆成两类：
- **强规则可判定**：格式、工具选择、卡片/选项结构对齐等（尽量规则化，减少主观漂移）
- **弱规则补充**：文本体验、思考质量、语气等（可用模型/人工抽检辅助）

### 核心思想：典型样本机制（让评估能指导动作）
评估输出应天然包含：
- 高分样本（学习“什么是对的”）
- 低分样本（定位“哪里坏了”）
- 结构错误样本、工具错误样本等（聚类错误模式）

### 核心思想：阈值映射行动（评估要“可执行”）
举例（抽象决策，不绑定具体阈值数值）：
- 格式差 → 先修结构（约束与数据）
- 工具差 → 修触发条件与对齐数据
- 卡片差 → 修输出契约与强规则
- 文本差 → 修信息覆盖与表达模板
- 思考差 → 修推理模板与训练数据

### 典型场景例子：评估发现大量结构错误（格式/标记/字数/卡片缺失）
正确处理思路：
- 暂停讨论 RL，先做“结构修复”的小步 SFT（成本低、收益大）
- 加质量闸门：训练数据与输出都做结构校验，不合格样本进入修复/重试
- 结构稳定后再决定是否需要 RL 来压边界漂移

### 典型场景例子：工具准确性低，但文本看起来“很合理”
这是客服类系统最常见的“假好”问题：

- 表面现象：模型回复很顺、很像人，但该调用动作时没调用/调用错
- 处理方式：
  - 在评估里把“工具是否正确”作为强规则维度（优先级高于文案）
  - 把这类样本聚类成“工具时机/工具选择”错误模式
  - 下一轮优先做：触发条件校正 + 定向修复数据（让模型学会什么时候必须触发动作）

---

## 项目三：SFT 数据生产线（生成、清洗、质量闸门）

### 一句话总结
把训练数据当成“流水线产物”：可规模化、可追踪、可重跑、有质量闸门，错误不扩散。

### 关键目标
把数据当作“产品”和“生产线”，而不是一次性文件：
- 可规模化生成（吞吐）
- 可追踪与可重跑（稳定）
- 可隔离错误（不被坏样本拖垮）
- 有质量闸门（保证训练输入可用）

### 核心思想：质量闸门（必做）
常见闸门（抽象）：
- 结构完整性（必须字段齐全）
- 输出约束（长度、格式、标记规范）
- 动作字段一致性（工具/卡片等结构字段合法）
- 异常隔离（错误样本进入错误队列/日志）

### 典型场景例子：生成数据时出现“结构不合格”
常见不合格类型：
- 输出超长（超出产品承接能力）
- 结构字段缺失（该有的动作/选项/关键字段没给）
- 标记不规范（下游无法解析，导致“看起来答了但系统用不了”）

处理方式：
- 不合格样本进入“错误队列”，记录原因
- 不要让不合格样本进入训练集（否则会放大错误）
- 如果这类错误高频：说明模板/约束设计有问题，优先修“生成规则”而不是盲目加数据

### 核心思想：从评估 badcase 反推“修复集”
不要“泛泛加数据”，而要：
- 从评估结果提炼错误模式
- 为每类错误模式构造小而准的修复样本
- 用重复采样/合并策略把修复集注入训练

---

## 项目四：训练与优化闭环（SFT → 需要时再 RL/GRPO）

### 一句话总结
先用低成本手段把系统变“可用且稳定”，再用 RL 去压边界与偏好；全程由评估驱动，而不是凭感觉训练。

### 关键目标
用最小成本，最大化提升“可用性与稳定性”，避免盲训。

### 核心思想：先修结构，再谈能力
常见高收益顺序：
- 先用 SFT 修：格式稳定、工具/卡片结构、字数等硬约束
- 结构稳定后，再用 RL/GRPO 强化：边界稳定性、工具时机偏好、减少偶发漂移

### 核心思想：最小闭环（小步快跑）
推荐的迭代节奏（抽象）：
1) 小步训练（控制时间/成本）
2) 快速评估（定位错误模式）
3) 生成修复数据（针对性）
4) 再训练与回归评估

复盘问题：
- 这次迭代是否有明确目标维度？
- 评估是否真正指导了数据与训练动作？
- 是否用最小代价拿到最大收益？

### 典型场景例子：什么时候“该用 RL”，什么时候“不该用 RL”
- 不该用 RL 的典型情况：
  - 大量结构错误（格式、标记、卡片/选项缺失）
  - 工具触发条件本身没定义清楚（先把门禁与契约写清楚）
  - 数据闸门缺失（先把数据生产线稳定下来）
- 该用 RL 的典型情况：
  - 结构基本稳定，但存在“偶发漂移”（同类输入偶尔输出不合规）
  - 工具时机属于偏好强化（不是简单规则能完全覆盖）
  - 需要在多个目标间做平衡（例如更稳 vs 更短 vs 更强动作倾向）

---

## 技术专题：分层排障清单（快速定位问题在哪一层）

当线上/离线效果出现问题时，用“分层”快速定位：
- **意图层**：分类错 → 后续全错（先修边界与上下文纠错）
- **上下文补全层**：该查没查/查错 → 模型只能编（先修查询与门禁）
- **策略层**：SOP 乱入/兜底乱飞 → 修阈值与引导策略
- **工具层**：不该调却调/该调不调 → 修触发条件与状态校验
- **输出契约层**：格式不稳 → 先把结构约束固化
- **评估层**：评估不导向行动 → 补典型样本与错误聚类

---

## 技术专题：你沉淀的可迁移能力地图（用于自我提升/面试叙事）

### 系统工程能力
- 能把 LLM 系统拆成层，并用门禁与契约控制不确定性
- 能把“先查再答/先查再执行”落成工程化流程
- 能设计 SOP 作为可运营资产（结构化、可迭代）

### 评估与闭环能力
- 能把“看分”变成“指导行动”（阈值→动作）
- 能用强规则减少漂移，用典型样本定位错误模式
- 能把评估结果反推数据与训练策略

### 数据工程能力
- 并发/批量/可恢复/错误隔离
- 质量闸门与可复现流程
- 基于 badcase 的定向修复数据构造

---

## 复盘模板（你未来每次迭代都能直接用）

### 本轮目标
- 想提升哪个维度？（结构/工具/卡片/文本/边界稳定性/成本）

### 约束与契约
- 哪些必须强规则？哪些允许弹性？

### 本轮行动
- 数据：新增/修复样本来自哪里？质量闸门是什么？
- 训练：为什么选 SFT 或 RL？训练幅度多大？
- 评估：用哪些维度判断“有效/无效”？典型错误模式是什么？

### 结果与结论
- 哪些维度提升明显？哪些没动？为什么？

### 下一步计划
- 明确下一轮的“一个主目标 + 两个次目标”（避免同时改太多导致不可归因）


